https://event.cloudnativedays.jp/cndt2023/talks/1963

メンバーほぼ全員が本番環境でのKubernetes経験あり」 

## 以降の背景と目的

2014年もともとawsで動いていた

iacされていない

てさぎょ

モニタリングダッシュボード分散

アワーとわれ

セキュリティ

スケーラビリティ

- 運用自動化
- iac導入
- インフラ設定の見直し

## なぜEKSにしたか

- 拡張性
    - helmを使うことでossやsaasとのインテグレーション拡張を簡単に
- インテクレーションやエコシステム

## 移設の計画と準備

- デモアプリの検証
- 別サービスをeksに移設
- 全面移設
    - 切り戻ししやすい順にバッチやバックエンドなど移設
    - aws関連はterraform
    - k8sリソースはマニフェスト
    - coreDNSとnode local Dns Cashを有効化しDNSのパフォーマンス向上
    - 運用型ツールの開発
        - k8sの操作をmakefileやslackを使ってできるようにした
        - githubactionsのセルフホステッドランナーをオートスケールする仕組みを開発して運用
    - モニタリング環境
        - datadog
            - 外径死活監視
        - promethus gragana
        - fluentbit
    - アラートの整理
        - info warm critical をルール決めした
- まず最初に定期バッチの移設
    - バッチ処理が失敗した原因がpodレベルの場合datadog,アプリケーションレベルの場合sentryを利用
    - バッチ処理のテスト実行、動作確認を愚直に実施
    - 定時バッチ処理のデプロイ　複数のcronjobをまとめて設定するためのカスタムコントローラーを作成してバッtいを簡単に移設できるようにした
- argo workflowsを利用したnoteの記事のインポートエクスポート機能
    - argo workflows
        - workflows内で同時に立ち上がるpod数を制御することで発行されるクエリを制御できる
- cert managerを利用した独自ドメイン機能
    - 証明書の管理の運用がほぼ無くなった
    - kubernetes内で自動で証明書を発行
    - daynemodb stremを使用
- バッチの次にアプリケーションを移設
    - 負荷試験の計画と実施
    - 負荷試験の目標と実施
        - 同等性能を出すためにpodがいくつ必要か算出する
        - パワメータを追うよりをここまでやるなど設定しないといくらでもやれちゃって時間なくなる
    - cloudfront continuousdeploymentを利用した切替作業
        - リクエスト総数の一定の割合をふりわけることができる
        - 段階的にリクエスト量を増やせる
        - エラーが発生した場合切り戻し可能
    - karpenter(EKS用オートスケーラー)の導入
        - nodeの管理に使用、より柔軟にnodeのオートスケールが可能
        - 1node = 1podでも立ち上げることが可能
- 運用
    - EKSのバージョンアップ
        - karpenterを導入したことによってnodeのバージョン管理が不要になった
- DX(開発者体験)の向上
    - ステージングの開発環境を即時に構築するシステムを開発した
        - アプリケーションごとにブランチを指定し、実行することでエンドポイントが作られる
        - どの環境のDBを利用できるか選択できる
        - 30分でリモート環境を構築できる
        - karpenter導入後にnode数の管理も不要に
- 障害発生時の対応フロー
    - EKS以降後メトリクスが充実し、サービスの状態をより詳細にモニタリングできるようになった
    - k8sにして良かったことしてロールバックが容易にできる
- 移行後の展望と次のステップ
    - SLI/SLOの策定
    - カナリアデプロイの導入
        - デプロイ後にエラーを検知した場合自動で切り戻せるようにする
    - KEDAを導入してHPSよりも詳細なメトリクスに応じたスケールアウト、スケールインする構成を目指して、スケーラビリティの向上
